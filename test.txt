// required rxjs imports at top of spec file if not already present:
// import { of, throwError } from 'rxjs';
// import { fakeAsync, tick } from '@angular/core/testing';

it('processRecord(): success with records -> stops loading, dispatches and shows modal', fakeAsync(() => {
  // prepare component state (all within the test)
  (component as any).worksheet = {
    mySheet: [
      { acctNbr: 'A1', miscAmt: 10, paidThru: '2025-01-01' },
      { acctNbr: 'A2', miscAmt: 20, paidThru: '2025-01-02' }
    ]
  };
  (component as any).sheetName = 'mySheet';
  (component as any).region = { regionId: 'R001' };

  // minimal utilities used in processRecord
  (component as any).utils = {
    getUploadDateAndDefaultTime: (v: any) => '2025-01-01T00:00:00.000Z',
    getCurrentUser: () => 'tester',
    ToEstDate: () => '2025-01-01T00:00:00.000Z'
  };

  // spies & mocks
  const postSpy = spyOn(component.feeApiservice, 'postRequest').and.returnValue(of({}));
  const dispatchSpy = spyOn((component as any).store, 'dispatch');
  const showSpy = jasmine.createSpy('showSpy');
  // actionModal is a component ViewChild; cast to any to avoid typing errors
  (component as any)._actionModal = { show: showSpy } as any;
  // spy displayServiceErrors just in case (shouldn't be called here)
  const displaySpy = spyOn(component as any, 'displayServiceErrors');

  // Act
  component.processRecord();
  tick();

  // Assert
  expect(postSpy).toHaveBeenCalled(); // HTTP POST invoked
  expect(component.loading).toBeFalse();
  expect(dispatchSpy).toHaveBeenCalledWith(jasmine.any(Object)); // LOADINGACTION(false) dispatched
  expect(component.totalRecordCount).toBe(2); // two rows produced
  expect(showSpy).toHaveBeenCalled(); // modal shown since totalRecordCount !== 0
  expect(displaySpy).not.toHaveBeenCalled();
}));


it('processRecord(): success with zero rows -> stops loading, dispatches and does NOT show modal', fakeAsync(() => {
  // worksheet with zero rows
  (component as any).worksheet = { mySheet: [] };
  (component as any).sheetName = 'mySheet';
  (component as any).region = { regionId: 'R002' };

  (component as any).utils = {
    getUploadDateAndDefaultTime: (v: any) => '2025-01-01T00:00:00.000Z',
    getCurrentUser: () => 'tester',
    ToEstDate: () => '2025-01-01T00:00:00.000Z'
  };

  const postSpy = spyOn(component.feeApiservice, 'postRequest').and.returnValue(of({})); // server returns ok
  const dispatchSpy = spyOn((component as any).store, 'dispatch');
  const showSpy = jasmine.createSpy('showSpy');
  (component as any)._actionModal = { show: showSpy } as any;
  const displaySpy = spyOn(component as any, 'displayServiceErrors');

  component.processRecord();
  tick();

  expect(postSpy).toHaveBeenCalled();
  expect(component.loading).toBeFalse();
  expect(dispatchSpy).toHaveBeenCalledWith(jasmine.any(Object));
  expect(component.totalRecordCount).toBe(0);
  expect(showSpy).not.toHaveBeenCalled(); // no modal when count === 0
  expect(displaySpy).not.toHaveBeenCalled();
}));


it('processRecord(): server error -> displayServiceErrors, clear loading and dispatch LOADINGACTION(false)', fakeAsync(() => {
  (component as any).worksheet = {
    mySheet: [{ acctNbr: 'A1', miscAmt: 5, paidThru: '2025-01-05' }]
  };
  (component as any).sheetName = 'mySheet';
  (component as any).region = { regionId: 'R003' };

  (component as any).utils = {
    getUploadDateAndDefaultTime: (v: any) => '2025-01-01T00:00:00.000Z',
    getCurrentUser: () => 'tester',
    ToEstDate: () => '2025-01-01T00:00:00.000Z'
  };

  const errorResponse = { error: { statusMessage: 'server failed' } };
  spyOn(component.feeApiservice, 'postRequest').and.returnValue(throwError(() => errorResponse));
  const dispatchSpy = spyOn((component as any).store, 'dispatch');
  const displaySpy = spyOn(component as any, 'displayServiceErrors').and.callThrough();
  const showSpy = jasmine.createSpy('showSpy');
  (component as any)._actionModal = { show: showSpy } as any;

  component.processRecord();
  tick();

  // Assertions
  expect(displaySpy).toHaveBeenCalledWith('server failed');
  expect(component.loading).toBeFalse();
  expect(dispatchSpy).toHaveBeenCalledWith(jasmine.any(Object));
  expect((component as any).totalRecordCount).toBeUndefined(); // not set on error
  expect(showSpy).not.toHaveBeenCalled();
}));