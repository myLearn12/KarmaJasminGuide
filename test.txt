it('onSaveClick(): success -> posts, handles next+complete', fakeAsync(() => {
  // let method pass validations
  spyOn(component as any, 'ValidateFormControls').and.returnValue(false);
  spyOn(component as any, 'validateDates').and.returnValue(false);
  spyOn(component as any, 'validateFormData').and.returnValue(false);

  // Provide appConfigService URL if your method uses it (optional)
  (component as any).appConfigService = (component as any).appConfigService || { addAccountUrl: '/api/addAccount' };

  // Provide all combo controls used in payload - ensure .value is non-null
  (component as any).cbCategory      = { value: '1' };
  (component as any).cbCycle         = { value: '1' };
  (component as any).cbFormula       = { value: '1' };
  (component as any).cbAltDivision   = { value: '0' }; // if code checks null, safe to give string
  (component as any).cbStatus        = { value: '1' };
  (component as any).cbOfficer       = { value: 'OFF1' };

  // Provide account object with fields referenced inside onSaveClick
  component.account = {
    accountNbr: 'ACC001',
    acceptfee: '0',
    estacc: '0',
    actpp: '0',
    cashpp: '0',
    endpp: '0',
    feepp: '0',
    revshare: null,
    longacctnum: null,
    pcanumber: null,
    futureuse: null,
    ozId: null,
    disposition1: null,
    disposition2: null,
    disposition3: null
  } as any;

  // Minimal utils implementation used by code (override private utils)
  (component as any).utils = {
    getFormattedDecimal: (v: any) => v,
    getValidString: (v: any) => (v === null || v === undefined) ? '' : v,
    getCurrentUser: () => 'TEST_USER',
    ToEstDate: () => '2025-01-01T00:00:00Z',
    getDateAndDefaultTime: (d: any) => d ?? null
  } as any;

  // spy logAccountAudit so we can assert it ran
  const logSpy = spyOn(component as any, 'logAccountAudit').and.stub();

  // Replace store and feeApiservice (private props) with test doubles
  (component as any).store = { dispatch: jasmine.createSpy('dispatch') } as any;
  (component as any).feeApiservice = {
    postRequest: jasmine.createSpy('postRequest').and.returnValue(of({})) // synchronous success
  } as any;

  // initial flags
  component.disableSavebtn = false;
  component.loading = false;

  // Call the method
  component.onSaveClick();
  // flush sync observable microtasks (not strictly necessary for of({}), but safe)
  tick();

  // Assertions
  expect((component as any).feeApiservice.postRequest).toHaveBeenCalled();
  expect((component as any).store.dispatch).toHaveBeenCalled(); // LOADINGACTION(true) was dispatched
  expect(component.errorBlockMessage).toBeNull();
  // After complete, loading should be reset and save button remains disabled? (complete calls logAudit)
  expect(component.loading).toBeFalse();
  expect(logSpy).toHaveBeenCalled();
}));


it('onSaveClick(): error -> clears loading, dispatches(false), shows error and enables save', fakeAsync(() => {
  // let validations pass so function proceeds to postRequest
  spyOn(component as any, 'ValidateFormControls').and.returnValue(false);
  spyOn(component as any, 'validateDates').and.returnValue(false);
  spyOn(component as any, 'validateFormData').and.returnValue(false);

  // controls and account filled like success test
  (component as any).cbCategory      = { value: '1' };
  (component as any).cbCycle         = { value: '1' };
  (component as any).cbFormula       = { value: '1' };
  (component as any).cbAltDivision   = { value: '0' };
  (component as any).cbStatus        = { value: '1' };
  (component as any).cbOfficer       = { value: 'OFF1' };

  component.account = { accountNbr: 'ACC001' } as any;

  (component as any).utils = {
    getFormattedDecimal: (v: any) => v,
    getValidString: (v: any) => (v === null || v === undefined) ? '' : v,
    getCurrentUser: () => 'TEST_USER',
    ToEstDate: () => '2025-01-01T00:00:00Z',
    getDateAndDefaultTime: (d: any) => d ?? null
  } as any;

  // Replace store and spy displayServiceErrors
  (component as any).store = { dispatch: jasmine.createSpy('dispatch') } as any;
  const displaySpy = spyOn(component as any, 'displayServiceErrors').and.stub();

  // Make postRequest throw an error
  const serverError = { error: { statusMessage: 'server failed' } };
  (component as any).feeApiservice = {
    postRequest: jasmine.createSpy('postRequest').and.returnValue(throwError(() => serverError))
  } as any;

  // initial flags
  component.disableSavebtn = false;
  component.loading = false;

  // run
  component.onSaveClick();
  tick();

  // assertions: error branch must be executed
  expect((component as any).feeApiservice.postRequest).toHaveBeenCalled();
  expect(displaySpy).toHaveBeenCalledWith('server failed');
  // flags must be reset
  expect(component.loading).toBeFalse();
  // LOADINGACTION(false) should be dispatched at end - store.dispatch was called (loose check)
  expect((component as any).store.dispatch).toHaveBeenCalled();
  // save button should be re-enabled
  expect(component.disableSavebtn).toBeFalse();
}));