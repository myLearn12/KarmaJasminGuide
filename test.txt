it('processRecord(): success with records -> stops loading, dispatches and shows modal', fakeAsync(() => {
  // preparation (all inside test)
  (component as any).worksheet = {
    mySheet: [
      { acctNbr: 'A1', miscAmt: 10, paidThru: '2025-01-01' },
      { acctNbr: 'A2', miscAmt: 20, paidThru: '2025-01-02' }
    ]
  };
  (component as any).sheetName = 'mySheet';
  (component as any).region = { regionId: 'R001' };

  // minimal utils used in processRecord
  (component as any).utils = {
    getUploadDateAndDefaultTime: (v: any) => '2025-01-01T00:00:00.000Z',
    getCurrentUser: () => 'tester',
    ToEstDate: () => '2025-01-01T00:00:00.000Z'
  };

  // ensure appConfigService has the URL property used by the method
  (component as any).appConfigService = { UploadCashFeeGFOPostingUrl: '/api/upload/gfo/' } as any;

  // spies & mocks
  const postSpy = spyOn(component.feeApiservice, 'postRequest').and.returnValue(of({}));
  const dispatchSpy = spyOn((component as any).store, 'dispatch');
  const showSpy = jasmine.createSpy('showSpy');
  (component as any)._actionModal = { show: showSpy } as any;
  const displaySpy = spyOn(component as any, 'displayServiceErrors');

  // Act
  component.processRecord();
  tick();

  // Assert
  expect(postSpy).toHaveBeenCalledWith('/api/upload/gfo/R001', jasmine.any(Array));
  expect(component.loading).toBeFalse();
  expect(dispatchSpy).toHaveBeenCalledWith(jasmine.any(Object)); // LOADINGACTION(false)
  expect(component.totalRecordCount).toBe(2);
  expect(showSpy).toHaveBeenCalled();
  expect(displaySpy).not.toHaveBeenCalled();
}));


it('processRecord(): success with zero rows -> stops loading, dispatches and does NOT show modal', fakeAsync(() => {
  (component as any).worksheet = { mySheet: [] };
  (component as any).sheetName = 'mySheet';
  (component as any).region = { regionId: 'R002' };

  (component as any).utils = {
    getUploadDateAndDefaultTime: (v: any) => '2025-01-01T00:00:00.000Z',
    getCurrentUser: () => 'tester',
    ToEstDate: () => '2025-01-01T00:00:00.000Z'
  };

  (component as any).appConfigService = { UploadCashFeeGFOPostingUrl: '/api/upload/gfo/' } as any;

  const postSpy = spyOn(component.feeApiservice, 'postRequest').and.returnValue(of({}));
  const dispatchSpy = spyOn((component as any).store, 'dispatch');
  const showSpy = jasmine.createSpy('showSpy');
  (component as any)._actionModal = { show: showSpy } as any;
  const displaySpy = spyOn(component as any, 'displayServiceErrors');

  component.processRecord();
  tick();

  expect(postSpy).toHaveBeenCalledWith('/api/upload/gfo/R002', jasmine.any(Array));
  expect(component.loading).toBeFalse();
  expect(dispatchSpy).toHaveBeenCalledWith(jasmine.any(Object));
  expect(component.totalRecordCount).toBe(0);
  expect(showSpy).not.toHaveBeenCalled();
  expect(displaySpy).not.toHaveBeenCalled();
}));


it('processRecord(): server error -> displayServiceErrors, clear loading and dispatch LOADINGACTION(false)', fakeAsync(() => {
  (component as any).worksheet = {
    mySheet: [{ acctNbr: 'A1', miscAmt: 5, paidThru: '2025-01-05' }]
  };
  (component as any).sheetName = 'mySheet';
  (component as any).region = { regionId: 'R003' };

  (component as any).utils = {
    getUploadDateAndDefaultTime: (v: any) => '2025-01-01T00:00:00.000Z',
    getCurrentUser: () => 'tester',
    ToEstDate: () => '2025-01-01T00:00:00.000Z'
  };

  (component as any).appConfigService = { UploadCashFeeGFOPostingUrl: '/api/upload/gfo/' } as any;

  const errorResponse = { error: { statusMessage: 'server failed' } };
  spyOn(component.feeApiservice, 'postRequest').and.returnValue(throwError(() => errorResponse));
  const dispatchSpy = spyOn((component as any).store, 'dispatch');
  const displaySpy = spyOn(component as any, 'displayServiceErrors').and.callThrough();
  const showSpy = jasmine.createSpy('showSpy');
  (component as any)._actionModal = { show: showSpy } as any;

  component.processRecord();
  tick();

  expect(displaySpy).toHaveBeenCalledWith('server failed');
  expect(component.loading).toBeFalse();
  expect(dispatchSpy).toHaveBeenCalledWith(jasmine.any(Object));
  expect((component as any).totalRecordCount).toBeUndefined();
  expect(showSpy).not.toHaveBeenCalled();
}));