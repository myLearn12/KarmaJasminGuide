import { of, throwError } from 'rxjs';
import { fakeAsync, tick } from '@angular/core/testing';

it('LoadBranchCd(): error -> calls displayServiceErrors and leaves combo arrays empty', fakeAsync(() => {
  // Arrange
  (component as any).appConfigService = (component as any).appConfigService || {} as any;
  (component as any).appConfigService.getAllBranchCdUrl = '/api/branchCds';

  // make feeApiservice.getRequest return an error observable
  const serverErr = { error: { statusMessage: 'Server failure for branch cds' } };
  spyOn(component.feeApiservice, 'getRequest').and.returnValue(throwError(() => serverErr));

  // Spy displayServiceErrors so we can assert it was called
  const displaySpy = spyOn(component as any, 'displayServiceErrors').and.callThrough();

  // Ensure internal arrays start empty
  (component as any).branchCdOptionsValues = [];
  component.branchCdComboBoxData = [];

  // Act
  (component as any).LoadBranchCd();
  tick();

  // Assert: displayServiceErrors invoked with server message
  expect(displaySpy).toHaveBeenCalledWith('Server failure for branch cds');

  // Assert: no options were pushed
  expect((component as any).branchCdOptionsValues).toEqual([]);
  expect(component.branchCdComboBoxData).toEqual([]);
}));


it('LoadBranchCd(): complete -> populates branchCdOptionsValues and pushes branchCdComboBoxData', fakeAsync(() => {
  // Arrange
  (component as any).appConfigService = (component as any).appConfigService || {} as any;
  (component as any).appConfigService.getAllBranchCdUrl = '/api/branchCds';

  const branchCds = [
    { branchCode: 'B1', branchDesc: 'Branch One' },
    { branchCode: 'B2', branchDesc: 'Branch Two' }
  ];

  // Return the successful response
  spyOn(component.feeApiservice, 'getRequest').and.callFake((url: string) => {
    expect(String(url || '')).toContain('/api/branchCds'); // sanity check (optional)
    return of(branchCds);
  });

  // Ensure arrays start empty
  (component as any).branchCdOptionsValues = [];
  component.branchCdComboBoxData = [];

  // If component dispatches LOADINGACTION in complete, stub store.dispatch to avoid side effects
  if (component['store']) {
    spyOn(component['store'], 'dispatch').and.callFake(() => {});
  }

  // Act
  (component as any).LoadBranchCd();
  tick();

  // Expected label/value: adjust if your implementation uses a different label template
  const expectedOptions = [
    { label: 'B1 Branch One', value: 'B1' },
    { label: 'B2 Branch Two', value: 'B2' }
  ];

  // Assert: for-loop pushed expected options
  expect((component as any).branchCdOptionsValues).toEqual(expectedOptions);

  // Assert: complete() pushed combo data with options
  expect(component.branchCdComboBoxData).toEqual([{ options: expectedOptions }]);
}));