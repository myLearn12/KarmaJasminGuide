// changetable.component.spec.ts
import { ComponentFixture, TestBed, fakeAsync, tick } from '@angular/core/testing';
import { ChangetableComponent } from './changetable.component';
import { CommonFunctionsService } from 'src/app/shared/services/commonfunctions.service';
import { ChangeReportService } from 'src/app/shared/services/changereport.service';
import { ChangereportComponent } from '../../changereport/changereport.component';
import { Store, select } from '@ngrx/store';
import { of, Subject, Subscription } from 'rxjs';
import { NO_ERRORS_SCHEMA } from '@angular/core';
import { LOADINGACTION } from 'src/common/ngrx/state';
import { getRegionId } from 'src/common/ngrx/reducers';

describe('ChangetableComponent (focused)', () => {
  let component: ChangetableComponent;
  let fixture: ComponentFixture<ChangetableComponent>;

  // spies / mocks
  let storeSpy: any;
  let utilsSpy: any;
  let reportServiceSpy: any;
  let changeReportSpy: any;

  beforeEach(async () => {
    // create jasmine spies for services
    utilsSpy = jasmine.createSpyObj('CommonFunctionsService', [
      'getPerPageItem',
      'getFilterTextMaxLength',
      'ToDate',
      'redirectToRegionSelection'
    ]);
    utilsSpy.getPerPageItem.and.returnValue(10);
    utilsSpy.getFilterTextMaxLength.and.returnValue(100);
    utilsSpy.ToDate.and.returnValue(new Date());

    reportServiceSpy = jasmine.createSpyObj('ChangeReportService', ['getChangeTable']);
    // default: empty change table
    reportServiceSpy.getChangeTable.and.returnValue([]);

    changeReportSpy = jasmine.createSpyObj('ChangereportComponent', ['getExcelExportData']);

    // store spy - we will implement .dispatch and .pipe(select(...))
    storeSpy = jasmine.createSpyObj('Store', ['dispatch', 'pipe']);
    // default pipe for getRegionId -> return observable with regionId defined (non-undefined)
    storeSpy.pipe.and.callFake((selectorFn: any) => {
      // If selector is getRegionId (we can't reliably inspect the function),
      // most tests will call ngOnInit and expect behavior when regionId is undefined.
      // We will override in specific tests by re-mocking storeSpy.pipe there.
      return of({ regionId: 'R1' });
    });

    await TestBed.configureTestingModule({
      declarations: [ChangetableComponent],
      providers: [
        { provide: CommonFunctionsService, useValue: utilsSpy },
        { provide: ChangeReportService, useValue: reportServiceSpy },
        { provide: ChangereportComponent, useValue: changeReportSpy },
        { provide: Store, useValue: storeSpy }
      ],
      schemas: [NO_ERRORS_SCHEMA]
    }).compileComponents();

    fixture = TestBed.createComponent(ChangetableComponent);
    component = fixture.componentInstance;

    // ensure the Subscription exists so tests can safely override/spy on it
    if (!component.subscription || !(component.subscription instanceof Subscription)) {
      component.subscription = new Subscription();
    }
  });

  afterEach(() => {
    // clean-up subscriptions to avoid leftover timers in async tests
    if (component && component.subscription) {
      component.subscription.unsubscribe();
    }
  });

  it('ngOnDestroy(): should unsubscribe from subscription', () => {
    // arrange
    const unsubSpy = jasmine.createSpy('unsubscribe');
    // replace component.subscription with an object having unsubscribe
    component.subscription = { unsubscribe: unsubSpy } as any;

    // act
    if ((component as any).ngOnDestroy) {
      (component as any).ngOnDestroy();
    }

    // assert
    expect(unsubSpy).toHaveBeenCalled();
  });

  it('ngOnInit(): when regionId is undefined should dispatch LOADINGACTION(false) and redirectToRegionSelection', fakeAsync(() => {
    // arrange: make store.pipe return undefined regionId
    storeSpy.pipe.and.callFake(() => of({ regionId: undefined }));

    const dispatchSpy = storeSpy.dispatch;

    // act
    component.ngOnInit();
    tick();

    // assertions
    // should set loading false and dispatch LOADINGACTION(false)
    expect(dispatchSpy).toHaveBeenCalledWith(jasmine.any(LOADINGACTION));
    // utils.redirectToRegionSelection should be called because regionId undefined
    expect(utilsSpy.redirectToRegionSelection).toHaveBeenCalled();
    // ensure component.loading is false
    expect(component.loading).toBeFalse();
  }));

  it('ngDoCheck(): when reportService.getChangeTable returns non-empty => isData true and loading false', () => {
    // arrange: make report service return a non-empty array
    reportServiceSpy.getChangeTable.and.returnValue([{ some: 'row' }]);

    // ensure initial values
    component.isData = false;
    component.loading = true;

    // act
    if ((component as any).ngDoCheck) {
      (component as any).ngDoCheck();
    } else {
      // Try calling ngDoCheck naming variants
      (component as any).ngDoCheck = (component as any).ngDoCheck;
    }

    // assert
    expect(reportServiceSpy.getChangeTable).toHaveBeenCalled();
    expect(component.changetable.length).toBeGreaterThan(0);
    expect(component.isData).toBeTrue();
    expect(component.loading).toBeFalse();
  });

  // small defensive test: displayServiceErrors sets errorBlockMessage
  it('displayServiceErrors(): sets errorBlockMessage', () => {
    component.displayServiceErrors('some error');
    expect(component.errorBlockMessage).toBe('some error');
  });
});